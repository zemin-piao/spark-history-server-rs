name: CI

permissions:
  contents: read

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0  # Disable incremental compilation to save disk space
  CARGO_NET_RETRY: 10
  RUSTFLAGS: "-C debuginfo=0"  # Disable debug info to reduce binary size

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker system prune -af || true
          echo "Disk space after cleanup:"
          df -h

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo dependencies (optimized)
        uses: Swatinem/rust-cache@v2
        with:
          # Only cache dependencies, not test binaries
          cache-targets: "false"
          shared-key: "ci"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run unit and integration tests (exclude large-scale tests)
        run: |
          # Run lib tests
          cargo test --lib --verbose

          # Run integration tests except large_scale_test
          cargo test --test integration_test
          cargo test --test analytics_api_test
          cargo test --test hdfs_integration_test
          cargo test --test incremental_scan_test
          cargo test --test batch_writer_debug_test
          cargo test --test argument_based_reader_test

      - name: Build release
        run: cargo build --release --bin spark-history-server

  # Large-scale performance tests (only run on demand)
  large-scale-tests:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[run-large-scale]') || github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker system prune -af || true
          echo "Disk space after cleanup:"
          df -h

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-targets: "false"
          shared-key: "large-scale"

      - name: Run large-scale tests in release mode
        run: |
          # Use release mode to reduce binary size
          cargo test --release --test large_scale_test
          cargo test --release --test load_test_utils

  # Optional: Integration tests with Docker (can be run manually or on schedule)
  integration-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[run-integration]')

    services:
      minio:
        image: quay.io/minio/minio:latest
        ports:
          - 9000:9000
          - 9001:9001
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin123
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      hdfs-namenode:
        image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
        ports:
          - 8020:8020
          - 9870:9870
        env:
          CLUSTER_NAME: test

    steps:
      - uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          docker system prune -af || true
          df -h

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-targets: "false"
          shared-key: "integration"

      - name: Wait for services
        run: |
          # Wait for MinIO
          for i in {1..30}; do
            if curl -f http://localhost:9000/minio/health/live; then break; fi
            sleep 2
          done

          # Wait for HDFS
          for i in {1..60}; do
            if curl -f http://localhost:9870; then break; fi
            sleep 2
          done

      - name: Run integration tests
        run: |
          export S3_TEST_BUCKET=spark-events
          export AWS_ENDPOINT_URL=http://localhost:9000
          export AWS_ACCESS_KEY_ID=minioadmin
          export AWS_SECRET_ACCESS_KEY=minioadmin123
          export AWS_REGION=us-east-1
          export HDFS_NAMENODE_URL=hdfs://localhost:8020
          cargo test --features integration-tests
